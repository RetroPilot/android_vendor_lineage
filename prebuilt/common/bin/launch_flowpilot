#!/system/bin/sh

while true; do
  if [ -f "/data/tmp/chroot_booted" ]
  then
    exit
  else
    break
  fi
done

monkey -p ai.flow.android -c android.intent.category.LAUNCHER 1


CHROOT=/data/ubuntu
SET_STAGE=$(cat /sdcard/.setup)

function setupUserSpace() {
    # run the other script
    # mount tmpfs and others\
    mount -o remount,dev,suid /data
    mount -t tmpfs -o size=2048M tmpfs /data/tmp
    mount --bind /data/tmp $CHROOT/tmp
    mount --bind /proc $CHROOT/proc
    mount --bind /dev $CHROOT/dev
    mount --bind /dev/null $CHROOT/dev/null
    mount --bind /dev/pts $CHROOT/dev/pts
    mount --bind /sys $CHROOT/sys
    mount --bind /sdcard $CHROOT/sdcard
    mount --bind /data $CHROOT/data
}

# login to the chroot
if [ "$SET_STAGE" -ge "2" ]
then
  if [ ! "`mount | grep "/data/tmp"`" ]; then
   echo "mounting filesystems"
   setupUserSpace
  else
   echo "filesystems already mounted!"
  fi
  log into the new userland
  echo "logging into userspace now"
  chroot $CHROOT /usr/bin/env HOME=/root PATH=/usr/local/sbin:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin:/usr/games:/usr/local/games TERM=xterm-256color LANG=C.UTF-8 SHELL=/bin/bash flowpilot_userland
fi