#!/system/bin/sh

# wait for the filesystems to actually mount
while [ "`getprop sys.boot_completed | tr -d '\r' `" != "1" ] ; do sleep 1; done
sleep 10

# globals
SET_STAGE=$(cat /sdcard/.setup)

# Get the user and group of the Termux binary
TERMUX_BINARY="/data/data/com.termux/files/usr/bin/bash"
TERMUX_USER=$(stat -c %U "$TERMUX_BINARY")
TERMUX_GROUP=$(stat -c %G "$TERMUX_BINARY")


monkey -p com.termux -c android.intent.category.LAUNCHER 1

# progress check
if [ ! -e "/sdcard/.setup" ]
then
  echo "0" > /sdcard/.setup
fi

if [ "$SET_STAGE" -eq "0" ]
then
  while true; do
    if [ -f "/data/data/com.termux/files/home/.termux/termux.properties" ]
    then
      sed -i '/allow-external-apps/s/^#*//g' /data/data/com.termux/files/home/.termux/termux.properties
      cp /etc/retros/setup_env_termux /data/data/com.termux/files/usr/bin/setup_env_termux

      chown "$TERMUX_USER:$TERMUX_GROUP" "/data/data/com.termux/files/usr/bin/setup_env_termux"
      chmod +x /data/data/com.termux/files/usr/bin/setup_env_termux

      pm disable com.termux
      pm enable com.termux
      echo "1" > /sdcard/.setup
      SET_STAGE=1
      break
    fi
    sleep 1
  done
fi

function disableSystemUI() {
  echo "Disabling systemui"
  LOOP_COUNT=0
  while [ $LOOP_COUNT -le 100 ]
  do
    pm disable com.android.systemui
    sleep 0.1
    LOOP_COUNT=$(( $LOOP_COUNT + 1 ))
  done
  echo "Disabled systemui"
}

# make the tmp dir
if [ ! -e "/data/tmp" ]
then
  mkdir /data/tmp
fi

# setup has not completed
# - lt "4"
if [ "$SET_STAGE" -lt "3" ]
then
  # wifi loop
  # do not progress until there's an internet connection
  while true; do
    if ping -c 1 8.8.8.8; then
      break
    elif [[ "$(dumpsys activity activities | grep mResumedActivity | cut -d "{" -f2 | cut -d ' ' -f3)" != 'com.android.settings/.Settings$NetworkDashboardActivity' ]]; then
      am start -a android.settings.WIRELESS_SETTINGS
    fi
    sleep 1
  done
  pm disable com.android.settings
  pm enable com.android.settings
  # TODO: launch the user setup. for now, just move setup along
  # am start org.retropilot.retros.usersetup
  echo "SET STAGE=$SET_STAGE"
fi

if [ "$SET_STAGE" -eq "1" ]
then
  disableSystemUI
  echo "2" > /sdcard/.setup
  SET_STAGE=2
  reboot
fi


monkey -p ai.flow.android -c android.intent.category.LAUNCHER 1